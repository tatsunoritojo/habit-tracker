# 開発者向け指示書：Phase 7 エール機能実装（更新版）

## 基本情報

| 項目 | 内容 |
|------|------|
| ドキュメント種別 | 開発指示書（更新版） |
| バージョン | 1.1 |
| 作成日 | 2025年11月27日 |
| 更新日 | 2025年11月27日 |
| 更新内容 | UXデザイナー・行動心理学アドバイザーのレポート統合 |

---

## 1. 承認済み事項

| 項目 | 決定内容 |
|------|----------|
| Firebase Blazeプラン | ✅ アップグレード承認済み |
| 遅延処理方式 | Cloud Functions scheduled invocation |
| FCM方式 | デバイス直接送信 |
| セキュリティルール更新 | 開発者側で直接修正OK |

---

## 2. 確定仕様

### 2.1 エール送信アルゴリズム

| パターン | トリガー | 遅延 | 対象条件 | 制限 |
|----------|----------|------|----------|------|
| ① record | ログ作成 | 5〜45分後（ランダム） | 全ユーザー | - |
| ② streak_break | 前日未記録 | 翌日の主要記録時間帯 | 前日に1件以上のカードで未記録 | 週2回まで |
| ③ long_absence | 7日/21日未記録 | 主要記録時間帯 or 土日午前 | カード単位で判定 | 最大3回/カード |
| ④ random | 2〜3日に1回 | 完全ランダム | 直近1週間で1回以上記録あり | - |

**主要記録時間帯の判定ロジック**
```javascript
// ユーザーの過去ログから最頻出時間帯を算出
// データ不足の場合のデフォルト: 19:00〜21:00
function getPrimaryRecordingHour(logs) {
  if (logs.length < 5) return { start: 19, end: 21 };
  // 時間帯別の記録数をカウントして最頻出を返す
  // ...
}
```

### 2.2 リアクション重み付け

```javascript
const REACTION_WEIGHTS = {
  record:       { cheer: 65, amazing: 20, support: 15 },
  streak_break: { cheer: 30, amazing: 10, support: 60 },
  long_absence: { cheer: 15, amazing: 5,  support: 80 },
  random:       { cheer: 33, amazing: 33, support: 34 }
};
```

### 2.3 エール文言リスト（確定版）

```javascript
const CHEER_MESSAGES = {
  // パターン①：記録直後（5〜45分後）
  record: {
    cheer: [
      "今日もナイス継続",
      "いい流れきてます",
      "その一歩すてき",
      "積み重ねが光ってる",
      "ペース、いい感じ",
      "今日の一歩も上々"
    ],
    amazing: [
      "すごくいいペース",
      "今日もキレてる",
      "続け方がうまいね",
      "いいリズム出てる",
      "流れつかんでるね",
      "伸び方がすてき"
    ],
    support: [
      "一緒にがんばってるよ",
      "こっちも今やってる",
      "同じ空気で進んでる",
      "仲間も今やってるよ",
      "今日も並んで歩こう",
      "となりで走ってる感"
    ]
  },
  
  // パターン②：継続途切れ翌日
  streak_break: {
    cheer: [
      "今日からまた一歩どう？",
      "ゆっくり戻ってこよ",
      "今日の一歩からでOK",
      "思い出したら一歩だけ",
      "できる日にやればOK",
      "軽く一歩踏み出そ"
    ],
    amazing: [
      "またすごい日が来そう",
      "積み重ね直前って感じ",
      "次の一歩が楽しみ",
      "ここからが面白いね",
      "また伸びていきそう",
      "未来の自分が楽しみ"
    ],
    support: [
      "少し休んでOK また一緒に",
      "ここからまた並走しよ",
      "いつでも隣で歩けるよ",
      "ペース戻すとき寄ってね",
      "今日は一緒にどう？",
      "また並んで進もうか"
    ]
  },
  
  // パターン③：長期離脱（7日/21日）
  long_absence: {
    cheer: [
      "思い出したら一歩だけ",
      "またいつでも再開OK",
      "久しぶりの一歩どう？",
      "一歩目はいつでも軽く",
      "小さく再開してみよ",
      "気が向いたらタップだけ"
    ],
    amazing: [
      "またすごい日が来そう"
    ],
    support: [
      "いつでもここで待ってる",
      "また一緒に始めよ",
      "離れてても仲間だよ",
      "戻る場所はここだよ",
      "思い出したら会おう",
      "ふらっと戻っておいで"
    ]
  },
  
  // パターン④：ランダム（2〜3日に1回）
  random: {
    cheer: [
      "そのペースすごくいい",
      "積み重ねが効いてる",
      "日々の一歩が光ってる",
      "マイペースが一番いい",
      "地味にすごいことしてる",
      "今日もいいリズムだね"
    ],
    amazing: [
      "コツコツがすごい力に",
      "最近の記録とてもいい",
      "やり方がほんと上手",
      "積み重ねが尊敬レベル",
      "その継続、普通にすごい",
      "じわじわ伸びてるね"
    ],
    support: [
      "遠くで一緒にやってるよ",
      "同じカードの仲間です",
      "みんなで少しずつ前へ",
      "どこかで並走してます",
      "今日も仲間がそばにいる",
      "同じ方向向いてるよ"
    ]
  }
};
```

### 2.4 制約・上限

| 項目 | 値 |
|------|-----|
| 1日あたりエール上限 | 3件/ユーザー |
| パターン②の週上限 | 2回/週 |
| パターン③の送信上限 | 3回/カード（1回目:7日、2回目:21日、3回目:35日） |
| お休みモード（デフォルト） | ON（23:00〜7:00） |

---

## 3. データモデル（確定版）

### 3.1 users コレクション拡張

```javascript
users/{uid}
{
  // 既存フィールド
  uid: string,
  created_at: timestamp,
  last_login_at: timestamp,
  
  settings: {
    // 既存
    cheer_frequency: string,      // "high" | "medium" | "low" | "off"
    push_enabled: boolean,
    timezone: string,             // "Asia/Tokyo"
    
    // 新規追加
    notification_mode: string,    // "realtime" | "batch"
    batch_times: string[],        // ["12:00", "18:00", "22:00"]
    quiet_hours_enabled: boolean, // デフォルト: true
    quiet_hours_start: string,    // デフォルト: "23:00"
    quiet_hours_end: string       // デフォルト: "07:00"
  },
  
  stats: { ... }
}
```

### 3.2 reactions コレクション拡張

```javascript
reactions/{reactionId}
{
  reaction_id: string,
  
  from_uid: string,               // システムエール: "system"
  to_uid: string,
  to_card_id: string,
  
  type: string,                   // "cheer" | "amazing" | "support"
  reason: string,                 // "record" | "streak_break" | "long_absence" | "random"
  message: string,                // エール文言（CHEER_MESSAGESから選択）
  
  created_at: timestamp,
  scheduled_for: timestamp | null, // まとめて通知用の配信予定時刻
  delivered: boolean,             // 配信済みフラグ
  is_read: boolean
}
```

### 3.3 cheer_state コレクション（新規）

```javascript
cheer_state/{odId}
{
  user_uid: string,
  
  // 1日あたりの送信カウント
  daily_count: number,
  daily_count_date: string,       // "YYYY-MM-DD"
  
  // パターン②用：週あたりの送信カウント
  weekly_streak_break_count: number,
  weekly_streak_break_reset_date: string, // 週の開始日
  
  // パターン④用：最終ランダムエール日時
  last_random_cheer_at: timestamp,
  
  // パターン③用：カード別の長期離脱エール送信履歴
  long_absence_cheers: {
    [card_id: string]: {
      count: number,              // 送信回数（最大3）
      last_sent_at: timestamp
    }
  },
  
  // ユーザーの主要記録時間帯（学習結果）
  primary_recording_hour: number | null, // 0-23、nullはデータ不足
  
  updated_at: timestamp
}
```

---

## 4. 通知仕様（確定版）

### 4.1 プッシュ通知の形式

**リアルタイム通知（個別）**
```
タイトル: 💪 ハビット仲間からエール！
本文: 「毎朝ストレッチ」今日もナイス継続
```

**まとめて通知（サマリー）**
```
タイトル: 🎉 今日のエールが届いています（3件）
本文: ハビット仲間からの応援をチェックしてみましょう
```

### 4.2 通知一覧（S07）での表示

```
────────────────────────────
🟢 [アイコン] ハビット仲間

💪 ナイス継続
「毎朝ストレッチ」にエールが届きました
（10:23）
────────────────────────────
```

- from_uid が "system" の場合、送信者名は「ハビット仲間」
- 将来の人間エールも同様に「ハビット仲間」で統一

### 4.3 ホーム画面（S03）でのエール表示

```
[カード：毎朝ストレッチ]
今日：✔   連続：7日
エール：💪⭐  from ハビット仲間
```

---

## 5. 画面追加

### 5.1 S09 今日のエール（新規）

まとめて通知タップ時の遷移先画面。

```
┌────────────────────────────┐
│ ←              今日のエール (3) │
├────────────────────────────┤
│                              │
│  [今日のハイライト]            │
│  ────────────────────        │
│  ⭐「英語学習」すごくいいペース │
│  💪「毎朝ストレッチ」ナイス継続  │
│  🤝「読書」また一緒に始めよ     │
│                              │
│  [一覧]                       │
│  ────────────────────        │
│  10:21  💪 ナイス継続          │
│         「毎朝ストレッチ」      │
│                              │
│  09:03  ⭐ すごい！            │
│         「英語学習」           │
│                              │
│  07:12  🤝 一緒にがんばろ       │
│         「読書」               │
│                              │
└────────────────────────────┘
```

**表示ロジック**
- 上部「ハイライト」: 当日のエールをリアクション種別でグループ化
- 下部「一覧」: 時刻順（発生時刻を表示）

---

## 6. 設定画面UI（確定版）

### 6.1 エール通知セクション

```
┌────────────────────────────┐
│  エール通知                   │
│  ─────────────────────       │
│                              │
│  通知方法                     │
│  (●) リアルタイム             │
│      エールが届いたらすぐに通知 │
│  (○) まとめて通知             │
│      選んだ時刻にまとめてお知らせ│
│                              │
│  ┌─ まとめて通知の配信時刻 ──┐ │
│  │ [12:00] [18:00] [22:00]  │ │
│  │ [+ 時刻を追加]            │ │
│  └─────────────────────┘ │
│                              │
│  お休みモード                 │
│  [ON ■]                      │
│  この時間帯のエール通知は止めて、│
│  あとでまとめてお届けします     │
│                              │
│  時間帯                       │
│  [ 23:00 ] 〜 [ 07:00 ]      │
│                              │
└────────────────────────────┘
```

### 6.2 実装仕様

| 項目 | 仕様 |
|------|------|
| 通知方法 | ラジオボタン（2択）: "realtime" / "batch" |
| まとめて通知の配信時刻 | 「まとめて通知」選択時のみ表示（条件付き表示） |
| 配信時刻 | チップ形式、タップで時間ピッカー、上限3件 |
| お休みモード | 独立トグル（通知方法とは別） |
| お休み時間帯 | 2つの時間ピッカー（開始・終了） |

---

## 7. 実装タスク（更新版）

### 7.1 Phase 7a：基盤実装（5〜7日目安）

| タスク | 内容 | 優先度 |
|--------|------|--------|
| 7a-1 | データモデル拡張（users, reactions, cheer_state） | 高 |
| 7a-2 | CheerService基盤実装（文言選択、重み付けロジック） | 高 |
| 7a-3 | パターン①実装（記録直後エール、5〜45分遅延） | 高 |
| 7a-4 | 通知一覧（S07）のシステムエール対応 | 高 |
| 7a-5 | 1日上限チェックロジック | 高 |
| 7a-6 | FCMプッシュ通知送信（デバイス直接） | 高 |

### 7.2 Phase 7b：追加パターン実装

| タスク | 内容 | 優先度 |
|--------|------|--------|
| 7b-1 | パターン②実装（継続途切れ翌日、週2回上限） | 中 |
| 7b-2 | パターン③実装（長期離脱、7日/21日/35日） | 中 |
| 7b-3 | パターン④実装（ランダム、直近1週間記録者限定） | 中 |
| 7b-4 | お休みモード基本実装（翌朝まとめて配信） | 中 |
| 7b-5 | 主要記録時間帯の学習ロジック | 中 |

### 7.3 Phase 7c：通知設定UI・追加画面

| タスク | 内容 | 優先度 |
|--------|------|--------|
| 7c-1 | 設定画面（S08）エール通知セクション実装 | 中 |
| 7c-2 | S09 今日のエール画面実装 | 中 |
| 7c-3 | まとめて通知機能（batch配信） | 低 |
| 7c-4 | ホーム画面（S03）エール表示更新 | 低 |

---

## 8. Cloud Functions 構成

### 8.1 関数一覧

| 関数名 | トリガー | 処理内容 |
|--------|----------|----------|
| onLogCreated | Firestore onCreate (logs) | パターン①のスケジュール登録 |
| sendDelayedCheer | Cloud Scheduler (1分ごと) | スケジュール済みエールの送信 |
| checkStreakBreak | Cloud Scheduler (毎朝9時) | パターン②③の判定・送信 |
| sendRandomCheer | Cloud Scheduler (6時間ごと) | パターン④の判定・送信 |
| deliverBatchNotifications | Cloud Scheduler (毎時0分) | まとめて通知の配信 |

### 8.2 スケジューラー設定

```javascript
// Cloud Scheduler 設定例

// sendDelayedCheer: 1分ごと
// schedule: "* * * * *"

// checkStreakBreak: 毎朝9時（JST）
// schedule: "0 9 * * *"
// timezone: "Asia/Tokyo"

// sendRandomCheer: 6時間ごと
// schedule: "0 */6 * * *"

// deliverBatchNotifications: 毎時0分
// schedule: "0 * * * *"
```

---

## 9. テスト要件

### 9.1 必須テスト項目

| シナリオ | 確認内容 |
|----------|----------|
| 記録直後エール | 記録後5〜45分でエールが届く |
| 文言ランダム | 同じパターンでも文言が変わる |
| 1日上限 | 4件目のエールが送信されない |
| お休みモード | 23:00〜7:00のエールが翌朝に届く |
| 通知一覧表示 | 「ハビット仲間」として表示される |
| まとめて通知 | 指定時刻にサマリー通知が届く |

### 9.2 推奨テスト項目

| シナリオ | 確認内容 |
|----------|----------|
| パターン② | 継続途切れ翌日にエール、週3回目は送信されない |
| パターン③ | 7日後、21日後、35日後にエール、4回目は送信されない |
| パターン④ | 1週間記録なしのユーザーには送信されない |
| タイムゾーン | 異なるtimezoneでお休みモードが正しく動作 |

---

## 10. 注意事項

### 10.1 文言の重複回避（推奨実装）

```javascript
// 直近N件のエールと同じ文言を避ける
async function selectMessage(userId, reason, type) {
  const recentMessages = await getRecentMessages(userId, 5);
  const candidates = CHEER_MESSAGES[reason][type];
  const available = candidates.filter(m => !recentMessages.includes(m));
  
  if (available.length === 0) {
    // 全て使用済みの場合はリセット
    return randomSelect(candidates);
  }
  return randomSelect(available);
}
```

### 10.2 エラーハンドリング

- Cloud Functions のタイムアウト: 60秒に設定
- Firestore 書き込み失敗時: リトライ（最大3回）
- FCM 送信失敗時: ログ記録、次回バッチで再試行しない（スキップ）

---

## 改訂履歴

| バージョン | 日付 | 変更内容 |
|------------|------|----------|
| 1.0 | 2025-11-27 | 初版作成 |
| 1.1 | 2025-11-27 | UXデザイナー・行動心理学アドバイザーのレポート統合、文言確定、S09画面追加 |
