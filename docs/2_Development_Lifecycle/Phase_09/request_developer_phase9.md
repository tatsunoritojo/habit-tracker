# 開発者向け指示書：Phase 9 アプリ完成

## 基本情報

| 項目 | 内容 |
|------|------|
| ドキュメント種別 | 開発指示書 |
| バージョン | 1.0 |
| 作成日 | 2025年11月28日 |
| 作成者 | プロジェクトマネージャー |
| 前提 | Phase 8（人間エール機能）完了済み |

---

## 1. Phase 9 概要

### 1.1 目的

アプリケーションの完成に向けて、以下の機能を実装します：

1. **カード追加UXの改善** - カテゴリ階層選択、オリジナルカード作成
2. **カード管理機能** - 削除、アーカイブ、復元
3. **アプリ基盤** - スプラッシュ、オンボーディング、アカウント管理
4. **通知・ゲーミフィケーション** - リマインダー、バッジ

### 1.2 設計方針

| 項目 | 方針 |
|------|------|
| オリジナルカードの共有 | MVP段階では共有しない（自分のみ使用） |
| 類似検索の対象 | 公式テンプレートのみ |
| アーカイブへのアクセス | ホーム画面のメニューから（達成感を味わえる場所に） |

---

## 2. タスクリスト

### 2.1 Phase 9A：カード追加UX改善（優先度：高）

| タスクID | 内容 | 工数目安 |
|----------|------|----------|
| 9A-1 | カテゴリ選択画面（L1表示） | 0.5日 |
| 9A-2 | サブカテゴリ・カード選択画面（L2→L3→テンプレート） | 1日 |
| 9A-3 | オリジナルカード作成画面 | 1日 |
| 9A-4 | 類似カード検索機能（公式テンプレート検索） | 0.5日 |
| 9A-5 | 類似検索結果UI（「これを使う」or「新規作成」） | 0.5日 |
| 9A-6 | オリジナルカードのカテゴリ選択UI | 0.5日 |

**小計：4日**

### 2.2 Phase 9B：カード管理機能（優先度：高）

| タスクID | 内容 | 工数目安 |
|----------|------|----------|
| 9B-1 | カード削除機能（Firestore削除処理） | 0.5日 |
| 9B-2 | 削除確認ダイアログ（データ消去警告、アーカイブ提案） | 0.5日 |
| 9B-3 | カードアーカイブ機能（statusフラグ更新） | 0.5日 |
| 9B-4 | アーカイブ確認ダイアログ | 0.5日 |
| 9B-5 | アーカイブ一覧画面（ホームからアクセス） | 1日 |
| 9B-6 | アーカイブ解除（復元）機能 | 0.5日 |
| 9B-7 | カード編集機能（公開/非公開、リマインダー時刻） | 0.5日 |

**小計：4日**

### 2.3 Phase 9C：アプリ基盤（優先度：高）

| タスクID | 内容 | 工数目安 |
|----------|------|----------|
| 9C-1 | スプラッシュ画面（S01） | 0.5日 |
| 9C-2 | オンボーディング画面（S02、3画面） | 1日 |
| 9C-3 | 初回起動判定ロジック | 0.5日 |
| 9C-4 | アカウント削除機能 | 1日 |
| 9C-5 | プライバシーポリシー表示（WebView or 外部リンク） | 0.5日 |
| 9C-6 | 利用規約表示（WebView or 外部リンク） | 0.5日 |

**小計：4日**

### 2.4 Phase 9D：通知・ゲーミフィケーション（優先度：中〜低）

| タスクID | 内容 | 工数目安 | 優先度 |
|----------|------|----------|--------|
| 9D-1 | リマインダー通知機能（Cloud Functions） | 1日 | 中 |
| 9D-2 | リマインダー時刻設定UI | 0.5日 | 中 |
| 9D-3 | バッジ機能（3種類） | 1日 | 低 |
| 9D-4 | おかえり演出（3日以上空いて記録時） | 0.5日 | 低 |

**小計：3日**

### 総工数目安：15日

---

## 3. データモデル

### 3.1 cards コレクション（拡張）

```javascript
cards/{cardId}
{
  // 既存フィールド
  card_id: string,
  owner_uid: string,
  category_l1: string,
  category_l2: string,
  category_l3: string,
  title: string,
  icon: string,                  // カードアイコン
  
  // テンプレート関連
  template_id: string | null,    // オリジナルの場合はnull
  is_custom: boolean,            // true = オリジナルカード
  
  // 公開設定
  is_public: boolean,
  
  // ステータス管理（新規追加）
  status: string,                // "active" | "archived"
  archived_at: timestamp | null, // アーカイブ日時
  
  // 統計（既存）
  current_streak: number,
  longest_streak: number,
  total_logs: number,
  last_log_date: string,
  
  // リマインダー設定（新規追加）
  reminder_enabled: boolean,
  reminder_time: string | null,  // "07:00" など
  
  created_at: timestamp,
  updated_at: timestamp
}
```

### 3.2 users コレクション（拡張）

```javascript
users/{uid}
{
  // 既存フィールド
  uid: string,
  created_at: timestamp,
  last_login_at: timestamp,
  
  // オンボーディング完了フラグ（新規追加）
  onboarding_completed: boolean,
  
  settings: {
    // 既存
    cheer_frequency: string,
    push_enabled: boolean,
    timezone: string,
    notification_mode: string,
    batch_times: string[],
    quiet_hours_enabled: boolean,
    quiet_hours_start: string,
    quiet_hours_end: string
  },
  
  stats: { ... }
}
```

### 3.3 削除時のデータ処理

カード削除時は以下のデータも削除：

```javascript
// 削除対象
1. cards/{cardId}           // カード本体
2. logs (card_id == cardId) // 該当カードのログ全件
3. reactions (to_card_id == cardId) // 該当カードへのエール全件
```

**注意：Cloud Functionsでのカスケード削除を推奨**

---

## 4. 画面設計

### 4.1 カテゴリ選択画面（S04改修）

**ファイル：** `app/add-card.tsx`（リファクタリング）

**画面構成：**

```
┌────────────────────────────┐
│ ←              習慣を選ぶ   │
├────────────────────────────┤
│                            │
│  カテゴリを選んでください    │
│                            │
│  ┌────────────────────┐    │
│  │ 💪 健康             │    │
│  │    運動・食事・睡眠   │    │
│  └────────────────────┘    │
│                            │
│  ┌────────────────────┐    │
│  │ 📚 学習             │    │
│  │    語学・読書・スキル  │    │
│  └────────────────────┘    │
│                            │
│  ┌────────────────────┐    │
│  │ 🏠 生活習慣          │    │
│  │    朝活・整理・お金   │    │
│  └────────────────────┘    │
│                            │
│  ┌────────────────────┐    │
│  │ 🎨 創作             │    │
│  │    執筆・アート・音楽  │    │
│  └────────────────────┘    │
│                            │
│  ┌────────────────────┐    │
│  │ 🧘 マインドフルネス   │    │
│  │    瞑想・感謝・メンタル │    │
│  └────────────────────┘    │
│                            │
├────────────────────────────┤
│  [✨ オリジナルを作成]       │
└────────────────────────────┘
```

**タップ時の動作：**
- カテゴリカード → サブカテゴリ・カード選択画面へ遷移
- 「オリジナルを作成」→ オリジナルカード作成画面へ遷移

### 4.2 サブカテゴリ・カード選択画面

**ファイル：** `app/select-card.tsx`（新規）

**画面構成：**

```
┌────────────────────────────┐
│ ←  健康                    │
├────────────────────────────┤
│                            │
│  習慣を選んでください        │
│                            │
│  ▼ 運動                    │
│  ┌────────────────────┐    │
│  │ 💪 毎日スクワット1回  │    │
│  └────────────────────┘    │
│  ┌────────────────────┐    │
│  │ 🏃 毎朝ストレッチ     │    │
│  └────────────────────┘    │
│  ┌────────────────────┐    │
│  │ 🚶 ウォーキング10分   │    │
│  └────────────────────┘    │
│                            │
│  ▼ 食事                    │
│  ┌────────────────────┐    │
│  │ 💧 水を1杯飲む       │    │
│  └────────────────────┘    │
│  ┌────────────────────┐    │
│  │ 🥗 野菜を食べる      │    │
│  └────────────────────┘    │
│                            │
│  ▼ 睡眠                    │
│  ┌────────────────────┐    │
│  │ 🌙 23時に寝る準備    │    │
│  └────────────────────┘    │
│                            │
└────────────────────────────┘
```

**仕様：**
- L2カテゴリはアコーディオン形式（展開/折りたたみ）
- デフォルトは全て展開
- カードタップで確認ダイアログ表示

### 4.3 オリジナルカード作成画面

**ファイル：** `app/create-custom-card.tsx`（新規）

**Step 1: 習慣名入力**

```
┌────────────────────────────┐
│ ←      オリジナルを作成     │
├────────────────────────────┤
│                            │
│  どんな習慣を続けたいですか？ │
│                            │
│  ┌────────────────────┐    │
│  │ 習慣の名前を入力...    │    │
│  └────────────────────┘    │
│                            │
│  [類似を検索]               │
│                            │
├────────────────────────────┤
│                            │
│  💡 ヒント                  │
│  似た習慣がすでにあれば、    │
│  同じカテゴリの仲間と        │
│  つながりやすくなります      │
│                            │
└────────────────────────────┘
```

**Step 2: 類似検索結果**

```
┌────────────────────────────┐
│ ←      類似する習慣         │
├────────────────────────────┤
│                            │
│  「プログラミング」で検索    │
│                            │
│  ┌────────────────────┐    │
│  │ 💻 プログラミング学習   │    │
│  │ 学習 > スキル          │    │
│  │          [これを使う]  │    │
│  └────────────────────┘    │
│                            │
│  ┌────────────────────┐    │
│  │ 📱 アプリ開発          │    │
│  │ 創作 > その他          │    │
│  │          [これを使う]  │    │
│  └────────────────────┘    │
│                            │
├────────────────────────────┤
│                            │
│  見つからない場合は...       │
│                            │
│  [新しく作成する]            │
│                            │
└────────────────────────────┘
```

**検索ロジック：**
```javascript
// card_templates から部分一致検索
const results = await db.collection('card_templates')
  .where('is_active', '==', true)
  .get();

// クライアント側でタイトル部分一致フィルタ
const filtered = results.docs.filter(doc => 
  doc.data().title_ja.includes(searchQuery) ||
  doc.data().title_en.toLowerCase().includes(searchQuery.toLowerCase())
);
```

**Step 3: カテゴリ選択（新規作成時）**

```
┌────────────────────────────┐
│ ←      カテゴリを選択       │
├────────────────────────────┤
│                            │
│  「毎日コーディング」の      │
│  カテゴリを選んでください    │
│                            │
│  ┌────────────────────┐    │
│  │ 📚 学習             │    │
│  │  ├─ 語学            │    │
│  │  ├─ 読書            │    │
│  │  └─ スキル ←        │    │  ← 選択状態
│  └────────────────────┘    │
│                            │
│  ┌────────────────────┐    │
│  │ 🎨 創作             │    │
│  │  ├─ 執筆            │    │
│  │  ├─ アート          │    │
│  │  └─ 音楽            │    │
│  └────────────────────┘    │
│                            │
│  [次へ]                     │
│                            │
└────────────────────────────┘
```

**Step 4: 確認・公開設定**

```
┌────────────────────────────┐
│ ←      確認                │
├────────────────────────────┤
│                            │
│  ┌────────────────────┐    │
│  │ 💻 毎日コーディング   │    │
│  │                    │    │
│  │ カテゴリ:           │    │
│  │ 学習 > スキル > その他│    │
│  └────────────────────┘    │
│                            │
│  ┌────────────────────┐    │
│  │ ☑ 公開する          │    │
│  │  （同じ習慣の仲間と    │    │
│  │   エールを送り合える） │    │
│  └────────────────────┘    │
│                            │
│  [この習慣を始める]          │
│                            │
└────────────────────────────┘
```

### 4.4 カード詳細画面のメニュー追加

**ファイル：** `app/card-detail/[id].tsx`（更新）

**メニュー構成：**

```
┌────────────────────────────┐
│ ←  毎朝ストレッチ     [︙]  │  ← 右上にメニューボタン
├────────────────────────────┤
│         ...                │
└────────────────────────────┘

[︙] タップ時のメニュー:
┌────────────────────┐
│ ✏️ 編集             │
│ 📦 アーカイブ       │
│ 🗑️ 削除            │
└────────────────────┘
```

### 4.5 削除確認ダイアログ

**コンポーネント：** `src/components/DeleteCardDialog.tsx`（新規）

```
┌────────────────────────────┐
│                            │
│  ⚠️ カードを削除しますか？   │
│                            │
│  「毎朝ストレッチ」を削除    │
│  すると、以下のデータが      │
│  完全に消去されます：        │
│                            │
│  ・記録履歴（23日分）        │
│  ・ストリーク情報            │
│  ・受け取ったエール          │
│                            │
│  この操作は取り消せません。   │
│                            │
│  ─────────────────────     │
│                            │
│  💡 一時停止したい場合は     │
│  「アーカイブ」がおすすめ    │
│                            │
│  [キャンセル]               │
│                            │
│  [アーカイブする]            │
│                            │
│  [削除する]  ← 赤色・警告色  │
│                            │
└────────────────────────────┘
```

**ボタンの配置：**
- キャンセル：グレー、上
- アーカイブする：青/緑、中
- 削除する：赤、下（最も目立たない位置に）

### 4.6 アーカイブ確認ダイアログ

**コンポーネント：** `src/components/ArchiveCardDialog.tsx`（新規）

```
┌────────────────────────────┐
│                            │
│  📦 アーカイブしますか？     │
│                            │
│  「毎朝ストレッチ」を        │
│  アーカイブすると：          │
│                            │
│  ・ホーム画面から非表示      │
│  ・記録データは保持          │
│  ・いつでも復元できます      │
│                            │
│  [キャンセル]  [アーカイブ]  │
│                            │
└────────────────────────────┘
```

### 4.7 アーカイブ一覧画面

**ファイル：** `app/archives.tsx`（新規）

**アクセス方法：** ホーム画面のヘッダーメニューから

```
┌────────────────────────────┐
│ ←          アーカイブ       │
├────────────────────────────┤
│                            │
│  📦 達成の記録              │
│                            │
│  ┌────────────────────┐    │
│  │ 📚 英語学習          │    │
│  │                    │    │
│  │ 累計: 45日達成       │    │
│  │ 最長連続: 14日       │    │
│  │ 最終記録: 2025/10/15 │    │
│  │                    │    │
│  │ [復元する]  [削除]   │    │
│  └────────────────────┘    │
│                            │
│  ┌────────────────────┐    │
│  │ 🏃 ランニング        │    │
│  │                    │    │
│  │ 累計: 30日達成       │    │
│  │ 最長連続: 10日       │    │
│  │ 最終記録: 2025/09/20 │    │
│  │                    │    │
│  │ [復元する]  [削除]   │    │
│  └────────────────────┘    │
│                            │
├────────────────────────────┤
│  💡 アーカイブした習慣は     │
│  いつでも復元できます        │
└────────────────────────────┘
```

**空状態：**

```
┌────────────────────────────┐
│                            │
│         📦                 │
│                            │
│  アーカイブした習慣は       │
│  まだありません              │
│                            │
│  習慣を一時停止したいときに  │
│  アーカイブを使ってください   │
│                            │
└────────────────────────────┘
```

### 4.8 ホーム画面のメニュー追加

**ファイル：** `app/(tabs)/home.tsx`（更新）

**ヘッダー構成：**

```
┌────────────────────────────┐
│ ≡                     🔔(2) │
├────────────────────────────┤
```

**≡ タップ時のメニュー：**

```
┌────────────────────┐
│ 📦 アーカイブ       │  ← 新規追加
│ ⚙️ 設定            │
└────────────────────┘
```

### 4.9 スプラッシュ画面（S01）

**ファイル：** `app/index.tsx`（更新）または `app/splash.tsx`（新規）

```
┌────────────────────────────┐
│                            │
│                            │
│                            │
│                            │
│         [アプリロゴ]         │
│                            │
│         Habit Tracker      │
│                            │
│                            │
│                            │
│         [ローディング]       │
│                            │
└────────────────────────────┘
```

**処理フロー：**
```javascript
useEffect(() => {
  const checkInitialRoute = async () => {
    // 1. Firebase Auth 状態確認
    const user = await getCurrentUser();
    
    if (!user) {
      // 2. 未認証 → 匿名認証実行
      await signInAnonymously();
    }
    
    // 3. オンボーディング完了確認
    const userData = await getUser(user.uid);
    
    if (!userData?.onboarding_completed) {
      // 4. 未完了 → オンボーディングへ
      router.replace('/onboarding');
    } else {
      // 5. 完了済み → ホームへ
      router.replace('/(tabs)/home');
    }
  };
  
  // 1.5秒後に判定実行
  setTimeout(checkInitialRoute, 1500);
}, []);
```

### 4.10 オンボーディング画面（S02）

**ファイル：** `app/onboarding.tsx`（新規）

**3画面構成（スワイプ or ボタンで進む）：**

**画面1: 1タップで記録**

```
┌────────────────────────────┐
│                            │
│      [イラスト: タップ]      │
│                            │
│                            │
│    「1タップで記録」         │
│                            │
│    毎日の習慣を              │
│    タップひとつで記録。       │
│    それだけ。                │
│                            │
│                            │
│         ● ○ ○              │
│                            │
│      [次へ →]               │
│                            │
└────────────────────────────┘
```

**画面2: テキストなしのエール**

```
┌────────────────────────────┐
│                            │
│      [イラスト: エール]      │
│                            │
│                            │
│    「テキストなしのエール」   │
│                            │
│    💪⭐🤝                  │
│    文字を打たなくても        │
│    気持ちは伝わる。          │
│                            │
│                            │
│         ○ ● ○              │
│                            │
│      [次へ →]               │
│                            │
└────────────────────────────┘
```

**画面3: 繋がりすぎない繋がり**

```
┌────────────────────────────┐
│                            │
│      [イラスト: 仲間]        │
│                            │
│                            │
│  「繋がりすぎない繋がり」     │
│                            │
│    同じ習慣を続ける仲間と     │
│    ゆるく、軽く、繋がる。     │
│                            │
│                            │
│         ○ ○ ●              │
│                            │
│      [始める]               │
│                            │
└────────────────────────────┘
```

**「始める」タップ後：**
1. `onboarding_completed: true` を保存
2. カード追加画面（S04）へ遷移

---

## 5. Cloud Functions

### 5.1 onCardDeleted（新規）

**トリガー：** Firestore onDelete (cards)

**処理：** カスケード削除

```javascript
exports.onCardDeleted = functions.firestore
  .document('cards/{cardId}')
  .onDelete(async (snap, context) => {
    const cardId = context.params.cardId;
    const cardData = snap.data();
    
    // 1. 該当カードのログを全削除
    const logs = await db.collection('logs')
      .where('card_id', '==', cardId)
      .get();
    
    const batch = db.batch();
    logs.docs.forEach(doc => batch.delete(doc.ref));
    
    // 2. 該当カードへのリアクションを全削除
    const reactions = await db.collection('reactions')
      .where('to_card_id', '==', cardId)
      .get();
    
    reactions.docs.forEach(doc => batch.delete(doc.ref));
    
    // 3. バッチ実行
    await batch.commit();
    
    console.log(`Deleted ${logs.size} logs and ${reactions.size} reactions for card ${cardId}`);
  });
```

### 5.2 sendReminder（新規・オプション）

**トリガー：** Cloud Scheduler（毎分 or 毎時）

**処理：** リマインダー通知送信

```javascript
exports.sendReminder = functions.pubsub
  .schedule('0 * * * *')  // 毎時0分
  .timeZone('Asia/Tokyo')
  .onRun(async (context) => {
    const now = new Date();
    const currentHour = now.getHours().toString().padStart(2, '0');
    const currentMinute = '00';  // 毎時0分のみ対象
    const currentTime = `${currentHour}:${currentMinute}`;
    
    // リマインダー設定が現在時刻のカードを取得
    const cards = await db.collection('cards')
      .where('status', '==', 'active')
      .where('reminder_enabled', '==', true)
      .where('reminder_time', '==', currentTime)
      .get();
    
    // 今日まだ記録していないカードのみ通知
    const today = getTodayString();
    
    for (const doc of cards.docs) {
      const card = doc.data();
      
      if (card.last_log_date === today) {
        continue;  // 今日記録済みはスキップ
      }
      
      // 通知送信
      await sendReminderNotification(card.owner_uid, card);
    }
  });
```

---

## 6. Firestoreセキュリティルール（更新）

```javascript
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // cards: 本人のみ全操作可能
    match /cards/{cardId} {
      allow read: if request.auth != null && 
        (resource.data.owner_uid == request.auth.uid || resource.data.is_public == true);
      allow create: if request.auth != null && 
        request.resource.data.owner_uid == request.auth.uid;
      allow update: if request.auth != null && 
        resource.data.owner_uid == request.auth.uid;
      allow delete: if request.auth != null && 
        resource.data.owner_uid == request.auth.uid;
    }
    
    // logs: 本人のみ（削除はCloud Functionsで実行）
    match /logs/{logId} {
      allow read, write: if request.auth != null && 
        resource.data.owner_uid == request.auth.uid;
      allow create: if request.auth != null && 
        request.resource.data.owner_uid == request.auth.uid;
    }
    
    // 既存ルールは維持
    // ...
  }
}
```

---

## 7. テスト要件

### 7.1 カード追加UX

| シナリオ | 確認内容 |
|----------|----------|
| カテゴリ選択 | L1カテゴリが5つ表示される |
| サブカテゴリ展開 | L2をタップで展開/折りたたみ |
| テンプレート選択 | カードをタップで確認ダイアログ |
| オリジナル作成 | 習慣名入力 → 検索 → カテゴリ選択 → 作成 |
| 類似検索 | 部分一致でテンプレートが表示される |
| 類似なし | 「新しく作成する」で作成フローへ |

### 7.2 カード管理

| シナリオ | 確認内容 |
|----------|----------|
| 削除フロー | 確認ダイアログ → データ消去警告 → 削除実行 |
| 削除後データ | ログ・リアクションも削除される |
| アーカイブ | ホーム画面から非表示になる |
| アーカイブ一覧 | アーカイブしたカードが表示される |
| 復元 | アーカイブから復元 → ホームに戻る |
| アーカイブから削除 | 完全削除が実行される |

### 7.3 アプリ基盤

| シナリオ | 確認内容 |
|----------|----------|
| 初回起動 | スプラッシュ → オンボーディング → カード追加 |
| 2回目起動 | スプラッシュ → ホーム（オンボーディングスキップ） |
| アカウント削除 | 全データ削除 → ログアウト |

---

## 8. 実装順序の推奨

### Phase 9A → 9B → 9C → 9D の順序で実装

**理由：**
1. **9A（カード追加UX）** が最も利用頻度が高い
2. **9B（カード管理）** は9Aと密接に関連
3. **9C（アプリ基盤）** はリリース前に必須
4. **9D（通知・バッジ）** は優先度が低め

### 詳細順序

```
Week 1:
├── 9A-1, 9A-2: カテゴリ選択UI
├── 9A-3, 9A-4, 9A-5, 9A-6: オリジナルカード作成

Week 2:
├── 9B-1, 9B-2: カード削除
├── 9B-3, 9B-4: アーカイブ
├── 9B-5, 9B-6: アーカイブ一覧・復元
└── 9B-7: カード編集

Week 3:
├── 9C-1, 9C-2, 9C-3: スプラッシュ・オンボーディング
├── 9C-4: アカウント削除
└── 9C-5, 9C-6: プライバシーポリシー・利用規約

Week 4 (オプション):
├── 9D-1, 9D-2: リマインダー通知
└── 9D-3, 9D-4: バッジ・おかえり演出
```

---

## 9. 注意事項

### 9.1 削除時のユーザー体験

- **削除ボタンは目立たない位置に**（誤タップ防止）
- **アーカイブを先に提案**（データ消去の回避）
- **削除は取り消せないことを明示**

### 9.2 アーカイブの価値訴求

- 「達成の記録」として表現
- 累計日数・最長連続を強調表示
- 「いつでも復元できる」安心感を伝える

### 9.3 オリジナルカードの制限

- MVP段階では**自分のみ使用可能**
- 共有機能は将来フェーズで検討
- カテゴリ選択は必須（マッチングに必要）

---

## 改訂履歴

| バージョン | 日付 | 変更内容 |
|------------|------|----------|
| 1.0 | 2025-11-28 | 初版作成 |
