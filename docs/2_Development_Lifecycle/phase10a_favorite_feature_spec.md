# Phase 10-A: お気に入り機能 実装指示書

## 基本情報

| 項目 | 内容 |
|------|------|
| フェーズ | 10-A |
| 機能名 | お気に入り（Favorites） |
| 目的 | 「常連さん」との緩い継続的な繋がりを実現 |
| 作成日 | 2025-12-08 |
| 作成者 | PM |

---

## 1. 背景と設計意図

### 1.1 なぜこの機能が必要か

現在のエール機能は完全ランダムマッチングのため、以下の課題があります：

- エールを送っても「誰に送ったか」が蓄積されない
- 「いつも応援してくれる誰か」の存在を感じにくい
- 人の温かみが希薄になりがち

### 1.2 設計思想

**「見えない糸で緩く繋がっている」感覚**

- 従来SNSの「フォロー/フォロワー」とは異なる
- 相手に通知されない一方的な登録
- 「名前も顔も知らないけど、いつも応援したくなる誰か」

### 1.3 コアコンセプトとの整合性

| 原則 | お気に入り機能での実現 |
|------|----------------------|
| 繋がりすぎない | 相手に通知なし、相互性不要 |
| 人の温かみ | ニックネーム表示、継続的な関係 |
| アプリ主導 | お気に入りは優先表示されるだけ |

---

## 2. 機能仕様

### 2.1 基本仕様

| 項目 | 仕様 |
|------|------|
| 登録上限 | **10人** |
| 相手への通知 | **なし** |
| 相互性 | **不要**（片方だけでOK） |
| 解除 | いつでも可能 |

### 2.2 識別表示

| 相手の状態 | 表示例 |
|------------|--------|
| ニックネーム設定済み | 「のぞみ」「朝活がんばる」 |
| ニックネーム未設定 | 「#7a3f」「#2b8c」（UID先頭4文字） |

**短縮ID生成ルール**:
- `uid.substring(0, 4).toLowerCase()`
- 表示時に `#` プレフィックスを付与

---

## 3. データモデル

### 3.1 新規コレクション: favorites

```typescript
favorites/{docId}
{
  doc_id: string;              // auto-generated
  owner_uid: string;           // お気に入り登録した人のUID
  target_uid: string;          // お気に入り対象のUID
  target_card_id: string;      // 対象のカードID
  category_l3: string;         // マッチングカテゴリ（検索用）
  created_at: Timestamp;
}
```

### 3.2 インデックス要件

```
// エール提案時のクエリ用
owner_uid ASC, category_l3 ASC

// 一覧取得用
owner_uid ASC, created_at DESC
```

### 3.3 Firestoreセキュリティルール

```javascript
match /favorites/{docId} {
  // 本人のみ作成・読み取り・削除可能
  allow create: if request.auth != null 
    && request.resource.data.owner_uid == request.auth.uid;
  allow read, delete: if request.auth != null 
    && resource.data.owner_uid == request.auth.uid;
  // 更新は不可（削除して再作成）
  allow update: if false;
}
```

---

## 4. 画面仕様

### 4.1 エール提案画面（S06）の変更

#### 4.1.1 カード表示の変更

**通常のカード**:
```
┌────────────────────────────┐
│ 筋トレ の仲間               │
│ のぞみ                      │  ← ニックネーム or 短縮ID
│ 連続 12日 / 今週 5回        │
│                            │
│ 💪継続  ⭐すごい  🤝一緒    │
│                     [☆]   │  ← お気に入りボタン（未登録）
└────────────────────────────┘
```

**お気に入り登録済みのカード**:
```
┌────────────────────────────┐
│ ★ 筋トレ の仲間             │  ← ★プレフィックス
│ のぞみ                      │
│ 連続 12日 / 今週 5回        │
│                            │
│ 💪継続  ⭐すごい  🤝一緒    │
│                     [★]   │  ← お気に入りボタン（登録済み）
└────────────────────────────┘
```

#### 4.1.2 表示順序

1. **お気に入りの仲間**（セクションヘッダー付き）
2. **その他の仲間**（従来通りランダム）

```
┌────────────────────────────┐
│            エールを送る      │
├────────────────────────────┤
│                            │
│  ★ お気に入りの仲間         │  ← セクションヘッダー
│                            │
│  ┌────────────────────┐    │
│  │ ★ 筋トレ の仲間      │    │
│  │ のぞみ              │    │
│  │ ...                 │    │
│  └────────────────────┘    │
│                            │
│  その他の仲間              │  ← セクションヘッダー
│                            │
│  ┌────────────────────┐    │
│  │ 英語学習 の仲間      │    │
│  │ #2b8c              │    │
│  │ ...                 │    │
│  └────────────────────┘    │
│                            │
└────────────────────────────┘
```

#### 4.1.3 お気に入りボタンの動作

| 状態 | タップ時の動作 |
|------|---------------|
| 未登録（☆） | favorites に追加、★に変化、トースト「お気に入りに追加しました」 |
| 登録済（★） | 確認なしで favorites から削除、☆に変化、トースト「お気に入りから解除しました」 |
| 上限到達時 | トースト「お気に入りは10人までです」、登録しない |

### 4.2 お気に入り一覧画面（新規: S11）

#### 4.2.1 画面構成

```
┌────────────────────────────┐
│ ←        お気に入りの仲間    │
├────────────────────────────┤
│                            │
│  ┌────────────────────┐    │
│  │ ★ のぞみ            │    │
│  │ 筋トレ / 連続 12日   │    │
│  │              [解除]  │    │
│  └────────────────────┘    │
│                            │
│  ┌────────────────────┐    │
│  │ ★ #7a3f            │    │
│  │ 英語学習 / 連続 5日  │    │
│  │              [解除]  │    │
│  └────────────────────┘    │
│                            │
│  ┌────────────────────┐    │
│  │ ★ 朝活がんばる       │    │
│  │ 早起き / 連続 21日   │    │
│  │              [解除]  │    │
│  └────────────────────┘    │
│                            │
├────────────────────────────┤
│  💡 お気に入りの仲間は       │
│     エール提案で優先的に     │
│     表示されます            │
└────────────────────────────┘
```

#### 4.2.2 「解除」ボタンの動作

- タップで確認ダイアログ表示
- 「解除する」で favorites から削除
- リストから即座に削除（アニメーション付き）

#### 4.2.3 空状態

```
┌────────────────────────────┐
│ ←        お気に入りの仲間    │
├────────────────────────────┤
│                            │
│                            │
│      ☆                    │
│                            │
│   お気に入りの仲間は         │
│   まだいません              │
│                            │
│   エール提案画面で           │
│   ☆をタップして追加         │
│                            │
│                            │
└────────────────────────────┘
```

### 4.3 画面遷移への追加

| 遷移元 | アクション | 遷移先 |
|--------|------------|--------|
| S08（設定） | 「お気に入りの仲間」タップ | S11 |
| S06（エール提案） | お気に入りボタン（☆/★） | その場で切り替え |

### 4.4 設定画面（S08）への追加

```
│  アカウント                 │
│  ─────────────────────     │
│  ニックネーム               │
│  [のぞみ          ]         │
│                            │
│  お気に入りの仲間            │  ← 新規追加
│  [3人 >]                   │
│                            │
│  データのエクスポート         │
```

---

## 5. ロジック仕様

### 5.1 お気に入り登録

```typescript
async function addFavorite(
  ownerUid: string,
  targetUid: string,
  targetCardId: string,
  categoryL3: string
): Promise<{ success: boolean; error?: string }> {
  // 1. 上限チェック
  const currentCount = await getFavoriteCount(ownerUid);
  if (currentCount >= 10) {
    return { success: false, error: 'LIMIT_REACHED' };
  }
  
  // 2. 重複チェック
  const existing = await findFavorite(ownerUid, targetCardId);
  if (existing) {
    return { success: false, error: 'ALREADY_EXISTS' };
  }
  
  // 3. 登録
  await addDoc(collection(db, 'favorites'), {
    owner_uid: ownerUid,
    target_uid: targetUid,
    target_card_id: targetCardId,
    category_l3: categoryL3,
    created_at: serverTimestamp()
  });
  
  return { success: true };
}
```

### 5.2 エール提案取得（変更）

```typescript
async function getCheerSuggestions(
  userUid: string,
  userCategories: string[]
): Promise<CheerSuggestion[]> {
  const suggestions: CheerSuggestion[] = [];
  
  for (const categoryL3 of userCategories) {
    // 1. お気に入りを優先取得
    const favorites = await getFavoritesByCategory(userUid, categoryL3);
    
    // 2. マッチングプールから取得（お気に入り除外）
    const pool = await getMatchingPool(categoryL3);
    const filtered = pool.filter(card => 
      card.owner_uid !== userUid &&
      !favorites.some(f => f.target_card_id === card.card_id)
    );
    
    // 3. マージ（お気に入り優先）
    suggestions.push(
      ...favorites.map(f => ({ ...f, isFavorite: true })),
      ...filtered.slice(0, 5).map(c => ({ ...c, isFavorite: false }))
    );
  }
  
  return suggestions;
}
```

### 5.3 表示名取得

```typescript
function getDisplayName(user: { uid: string; display_name?: string }): string {
  if (user.display_name && user.display_name.trim() !== '') {
    return user.display_name;
  }
  return `#${user.uid.substring(0, 4).toLowerCase()}`;
}
```

---

## 6. 実装タスク

### 6.1 バックエンド

| # | タスク | 優先度 |
|---|--------|--------|
| 1 | favorites コレクション作成 | 高 |
| 2 | Firestore セキュリティルール追加 | 高 |
| 3 | インデックス作成 | 高 |

### 6.2 フロントエンド

| # | タスク | 優先度 |
|---|--------|--------|
| 1 | useFavorites フック作成 | 高 |
| 2 | エール提案画面の改修（お気に入りボタン、セクション分け） | 高 |
| 3 | お気に入り一覧画面（S11）新規作成 | 高 |
| 4 | 設定画面への導線追加 | 中 |
| 5 | 表示名取得ロジック（useUserDisplayName活用） | 中 |

### 6.3 新規ファイル

```
app/
  favorites.tsx              # S11 お気に入り一覧画面

src/
  hooks/
    useFavorites.ts          # お気に入り管理フック
  services/
    favoriteService.ts       # お気に入りCRUD
  components/
    FavoriteButton.tsx       # ☆/★切り替えボタン
    CheerSuggestionCard.tsx  # エール提案カード（改修）
```

---

## 7. テスト観点

### 7.1 機能テスト

| # | テストケース | 期待結果 |
|---|-------------|----------|
| 1 | お気に入り登録（初回） | favorites に追加、★表示 |
| 2 | お気に入り登録（上限10人） | エラートースト、登録されない |
| 3 | お気に入り解除 | favorites から削除、☆表示 |
| 4 | エール提案でお気に入り優先表示 | ★セクションが上部に表示 |
| 5 | ニックネーム表示（設定あり） | ニックネームが表示 |
| 6 | ニックネーム表示（未設定） | #xxxx 形式で表示 |

### 7.2 エッジケース

| # | ケース | 期待動作 |
|---|--------|----------|
| 1 | 対象ユーザーが退会 | 一覧から自動削除（または非表示） |
| 2 | 対象カードが削除/アーカイブ | 一覧から自動削除（または非表示） |
| 3 | 同じカードを複数回登録しようとする | 重複登録されない |

---

## 8. 注意事項

### 8.1 プライバシー配慮

- **お気に入り登録は相手に通知しない**（これが最重要）
- 相手側からは「誰が自分をお気に入りしているか」を確認できない
- エールを送っても「お気に入りから送られた」とは表示しない

### 8.2 パフォーマンス

- favorites コレクションは owner_uid でクエリするため、インデックス必須
- エール提案時の追加クエリは1回（お気に入り取得）のみ

### 8.3 既存機能への影響

- useCheerSuggestions フックの改修が必要
- エール提案画面のUI変更あり
- 他の機能への影響は最小限

---

## 9. 成果物チェックリスト

- [ ] favorites コレクション + セキュリティルール
- [ ] useFavorites フック
- [ ] favoriteService
- [ ] FavoriteButton コンポーネント
- [ ] エール提案画面（S06）改修
- [ ] お気に入り一覧画面（S11）
- [ ] 設定画面（S08）への導線
- [ ] 表示名ロジック統合
- [ ] 単体テスト
- [ ] 結合テスト

---

## 10. 質問・確認事項

実装中に以下の点で判断が必要な場合は、PMに確認してください：

1. 対象ユーザー/カードが削除された場合の処理方針
2. お気に入り上限数の変更要否
3. UIアニメーションの詳細

---

## 改訂履歴

| バージョン | 日付 | 変更内容 |
|------------|------|----------|
| 1.0 | 2025-12-08 | 初版作成 |
