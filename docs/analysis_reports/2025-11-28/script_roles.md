# スクリプト役割定義書

## 概要

このドキュメントは、`habit-tracker` アプリケーションを構成する主要なスクリプトファイル（`.tsx`, `.ts`）の役割と責任を定義します。

---

## 1. フロントエンド (`app` & `src`)

### 1.1. 画面コンポーネント (`app/**/*.tsx`)

Expo Router を利用したファイルベースのルーティングに従います。各ファイルがアプリケーションの1画面に対応します。

| ファイルパス | 役割 | 説明 |
| :--- | :--- | :--- |
| `app/_layout.tsx` | **ルートレイアウト** | アプリケーション全体のラッパー。Firebase・プッシュ通知の初期化、匿名認証の実行、ローディング/エラー画面の表示を担当。 |
| `app/index.tsx` | **エントリポイント** | アプリ起動後の最初のエントリ。UIは持たず、即座にホーム画面 `/(tabs)/home` へリダイレクトする。 |
| `app/(tabs)/_layout.tsx` | **タブレイアウト** | 下部タブナビゲーションを定義。「ホーム」「エール」「通知」「設定」の4つのタブを構成する。 |
| `app/(tabs)/home.tsx` | **ホーム画面** | アプリのメイン画面。習慣カードの一覧、週/月の達成状況、最新のエールを表示。カードのタップによるログ記録や詳細画面への遷移を処理する。 |
| `app/(tabs)/cheers.tsx` | **エール提案画面 (未実装)** | 他のユーザーにエールを送信するためのプレースホルダー画面。現在は「実装予定」のテキストが表示されるのみ。 |
| `app/(tabs)/notifications.tsx`| **通知一覧画面** | システムから受け取った「エール」を一覧表示する受信ボックス。エールの既読管理機能を持つ。 |
| `app/(tabs)/settings.tsx` | **設定画面** | 通知のON/OFF、通知モード（リアルタイム/まとめて）、お休みモード、エール頻度など、ユーザー設定を管理する。 |
| `app/add-card.tsx` | **カード追加画面** | 新しい習慣カードを作成する画面。定義済みのテンプレートから習慣を選択し、公開/非公開を設定してカードを作成する。 |
| `app/card-detail/[id].tsx`| **カード詳細画面** | 個別の習慣カードの詳細情報を表示する動的ルート画面。統計（連続日数など）と、ログを記録した日を可視化するカレンダーを表示する。 |
| `app/today-cheers.tsx` | **今日のエール画面** | 「まとめて通知」をタップした際の遷移先。その日に受け取ったエールをハイライトと時系列一覧で表示する。 |
| `src/components/Calendar.tsx` | **カレンダーコンポーネント**| ログが記録された日付をハイライト表示する、再利用可能な月間カレンダーコンポーネント。 |

### 1.2. ビジネスロジック & データ層 (`src/**/*.ts`)

UIから分離された、アプリケーションのコアロジックとデータアクセスを管理します。

#### Hooks (`src/hooks/*.ts`)

Firestoreとのやり取りや、それに伴う状態（データ、ローディング、エラー）管理をカプセル化するカスタムフック群。

| ファイルパス | 役割 | 説明 |
| :--- | :--- | :--- |
| `src/hooks/useCards.ts` | **カード一覧取得フック** | 現在のユーザーが所有する習慣カードの一覧をリアルタイムで取得する。 |
| `src/hooks/useCardLogs.ts` | **カードログ取得フック** | 特定のカードIDに紐づくログ履歴をリアルタイムで取得する。 |
| `src/hooks/useReactions.ts`| **エール受信フック** | 現在のユーザーが受け取ったエールの一覧をリアルタイムで取得し、既読管理機能を提供する。 |
| `src/hooks/useSettings.ts` | **ユーザー設定フック** | ユーザー設定オブジェクトをリアルタイムで取得し、更新機能を提供する。 |
| `src/hooks/useStats.ts` | **ユーザー統計フック** | ログの変更をトリガーに、週次・月次の達成日数を再計算して提供する。 |
| `src/hooks/useTemplates.ts`| **テンプレート取得フック**| カード作成時に使用する、公式の習慣テンプレート一覧を一度だけ取得する。 |

#### Lib (`src/lib/*.ts`)

アプリケーション全体で利用される、コアなライブラリの初期化や設定を担当します。

| ファイルパス | 役割 | 説明 |
| :--- | :--- | :--- |
| `src/lib/firebase.ts` | **Firebase初期化** | Firebase Appを初期化し、AuthとFirestoreのインスタンスをエクスポートする。アプリ起動時の匿名認証とユーザードキュメントの作成/更新ロジックも含む。 |
| `src/lib/notifications.ts`| **プッシュ通知初期化** | プッシュ通知の権限要求、FCMトークンの取得と保存、通知受信リスナーの設定など、通知関連の初期化処理をまとめる。 |

#### Services (`src/services/*.ts`)

より具体的なビジネスロジックや計算処理を担当するサービス層。

| ファイルパス | 役割 | 説明 |
| :--- | :--- | :--- |
| `src/services/logService.ts` | **ログ記録サービス** | ログの新規作成と、それに伴うカード統計（現在/最長ストリーク、総ログ数）の複雑な計算と更新処理を担当する。 |
| `src/services/statsService.ts` | **統計計算サービス** | ユーザーの全ログを集計し、週/月のユニークな活動日数を計算する。 |

#### Types (`src/types/*.ts`)

| ファイルパス | 役割 | 説明 |
| :--- | :--- | :--- |
| `src/types/index.ts` | **型定義** | アプリケーション全体（フロントエンド・バックエンド含む）で使用されるデータ構造（`User`, `Card`, `Reaction`など）のTypeScript型を定義する。 |

---

## 2. バックエンド (`functions/src/**/*.ts`)

Firebase Cloud Functionsとしてデプロイされるサーバーサイドのロジック。主に、システムが能動的にユーザーに働きかける「システムエール」機能を担当する。

| ファイルパス | 役割 | 説明 |
| :--- | :--- | :--- |
| `functions/src/index.ts`| **Cloud Functionsエントリーポイント** | 全てのCloud Functionトリガー（Firestore, Pub/Sub）を定義する。ログ作成やスケジュール実行に応じて`cheerService`を呼び出し、エール送信の起点となる。 |
| `functions/src/services/cheerService.ts` | **エール送信サービス** | システムエールの頭脳。送信理由に基づいたメッセージ選択、重複排除、送信上限管理、お休みモード判定など、エール送信に関する全てのビジネスロジックを実装する。 |
