rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ========================================
    // users: ユーザー情報
    // ========================================
    match /users/{uid} {
      // 読み取り: 認証済み全員（display_name取得のため）
      // TODO: 本番前に public_profiles サブコレクション化を検討
      allow read: if request.auth != null;
      
      // 書き込み: 本人のみ
      allow write: if request.auth != null && request.auth.uid == uid;
    }

    // ========================================
    // cards: 習慣カード
    // ========================================
    match /cards/{cardId} {
      // 読み取り: 本人 OR 公開カード（エール用/テンプレート用）
      allow read: if request.auth != null && (
        resource.data.owner_uid == request.auth.uid ||
        resource.data.is_public == true ||
        resource.data.is_public_for_cheers == true ||
        resource.data.is_public_for_template == true
      );
      
      // 作成: 本人のみ
      allow create: if request.auth != null 
        && request.resource.data.owner_uid == request.auth.uid;
      
      // 更新・削除: 本人のみ
      allow update, delete: if request.auth != null 
        && resource.data.owner_uid == request.auth.uid;
    }

    // ========================================
    // logs: 達成ログ
    // ========================================
    match /logs/{logId} {
      // 読み取り: 本人のみ
      allow read: if request.auth != null 
        && resource.data.owner_uid == request.auth.uid;
      
      // 作成: 本人のみ
      allow create: if request.auth != null 
        && request.resource.data.owner_uid == request.auth.uid;
      
      // 更新・削除: 本人のみ
      allow update, delete: if request.auth != null 
        && resource.data.owner_uid == request.auth.uid;
    }

    // ========================================
    // categories, card_templates: マスタデータ
    // ========================================
    match /categories/{doc} {
      allow read: if request.auth != null;
      allow write: if false;
    }
    
    match /card_templates/{doc} {
      allow read: if request.auth != null;
      allow write: if false;
    }

    // ========================================
    // matching_pools: マッチングプール
    // ========================================
    match /matching_pools/{doc} {
      allow read: if request.auth != null;
      allow write: if false;  // Cloud Functionsのみ
    }

    // ========================================
    // reactions: エール（リアクション）
    // ========================================
    match /reactions/{reactionId} {
      // 作成: 認証済み、かつ from_uid は自分自身
      // ※ from_uid="system" は Cloud Functions (Admin SDK) のみ
      allow create: if request.auth != null 
        && request.resource.data.from_uid == request.auth.uid;
      
      // 読み取り: 送信者 OR 受信者
      allow read: if request.auth != null && (
        resource.data.from_uid == request.auth.uid ||
        resource.data.to_uid == request.auth.uid
      );
      
      // 更新: 受信者のみ（is_read更新用）
      allow update: if request.auth != null 
        && resource.data.to_uid == request.auth.uid;
      
      // 削除: 送信者のみ（アンドゥ用）
      allow delete: if request.auth != null 
        && resource.data.from_uid == request.auth.uid;
    }

    // ========================================
    // cheer_state: AIエール状態管理
    // ========================================
    match /cheer_state/{docId} {
      allow read: if request.auth != null && docId == request.auth.uid;
      allow write: if false;  // Cloud Functionsのみ
    }

    // ========================================
    // cheer_send_state: 人間エール送信制限
    // ========================================
    match /cheer_send_state/{docId} {
      allow read, write: if request.auth != null && docId == request.auth.uid;
    }

    // ========================================
    // favorites: お気に入り
    // ========================================
    match /favorites/{docId} {
      allow create: if request.auth != null 
        && request.resource.data.owner_uid == request.auth.uid;
      allow read, delete: if request.auth != null 
        && resource.data.owner_uid == request.auth.uid;
      allow update: if false;
    }
  }
}
