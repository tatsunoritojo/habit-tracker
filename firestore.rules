rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // users: 本人のみ
    match /users/{uid} {
      allow read, write: if request.auth != null && request.auth.uid == uid;
    }

    // cards: 本人は全操作、他者は公開のみ読み取り
    match /cards/{cardId} {
      allow read: if request.auth != null &&
        (resource.data.owner_uid == request.auth.uid || resource.data.is_public == true);
      allow create: if request.auth != null && request.resource.data.owner_uid == request.auth.uid;
      allow update, delete: if request.auth != null && resource.data.owner_uid == request.auth.uid;
    }

    // logs: 本人のみ
    match /logs/{logId} {
      allow read: if request.auth != null && resource.data.owner_uid == request.auth.uid;
      allow create: if request.auth != null && request.resource.data.owner_uid == request.auth.uid;
      allow update, delete: if request.auth != null && resource.data.owner_uid == request.auth.uid;
    }

    // categories, card_templates: 全員読み取り
    match /categories/{doc} {
      allow read: if request.auth != null;
    }
    match /card_templates/{doc} {
      allow read: if request.auth != null;
    }

    // matching_pools: 読み取りのみ（認証済みユーザー）
    match /matching_pools/{doc} {
      allow read: if request.auth != null;
      allow write: if false; // Cloud Functions のみが書き込み可能
    }

    // reactions: 送信者は作成、受信者は読み取り・更新
    // Phase 7: システムエール（from_uid="system"）を許可
    // Phase 8: 人間エール（from_uid=自分）を許可
    match /reactions/{reactionId} {
      allow create: if request.auth != null &&
        (request.resource.data.from_uid == request.auth.uid || request.resource.data.from_uid == "system");
      allow read, update: if request.auth != null && resource.data.to_uid == request.auth.uid;
    }

    // cheer_state: Cloud Functions のみ（管理者権限で操作）
    match /cheer_state/{docId} {
      allow read: if request.auth != null && resource.data.user_uid == request.auth.uid;
      allow write: if false; // Cloud Functions のみが書き込み可能
    }

    // cheer_send_state: 本人のみ読み書き（Phase 8）
    match /cheer_send_state/{docId} {
      allow read, write: if request.auth != null && resource.data.user_uid == request.auth.uid;
      allow create: if request.auth != null && request.resource.data.user_uid == request.auth.uid;
    }
  }
}
